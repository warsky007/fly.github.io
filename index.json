[{"authors":null,"categories":null,"content":"作为一名资深的软件攻城狮，我在系统底层耕耘了很多年。为了给孩子挣点奶粉钱，我毅然加入了沪漂一族。在上海遇到一些有趣的人，做了一些有意义的事。\n在这个世界上，浅薄的人才会去追逐“表面的有趣”，而厉害的人，都在享受“深层的乐趣”。我愿在技术的道路上不断精进，越做越好。\n有人说搞技术的人都很闷，对此我不敢苟同，我一点都不闷，只是有点骚。当然这个骚不是说我有多骚，主要是代码风骚。\n","date":1610409600,"expirydate":-62135596800,"kind":"term","lang":"en","lastmod":1610409600,"objectID":"2525497d367e79493fd32b198b28f040","permalink":"","publishdate":"0001-01-01T00:00:00Z","relpermalink":"","section":"authors","summary":"作为一名资深的软件攻城狮，我在系统底层耕耘了很多年。为了给孩","tags":null,"title":"Warsky007","type":"authors"},{"authors":[],"categories":null,"content":" Click on the Slides button above to view the built-in slides feature.   Slides can be added in a few ways:\n Create slides using Wowchemy\u0026rsquo;s Slides feature and link using slides parameter in the front matter of the talk file Upload an existing slide deck to static/ and link using url_slides parameter in the front matter of the talk file Embed your slides (e.g. Google Slides) or presentation video on this page using shortcodes.  Further event details, including page elements such as image galleries, can be added to the body of this page.\n","date":1906549200,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1906549200,"objectID":"a8edef490afe42206247b6ac05657af0","permalink":"https://warsky007.github.io/talk/example-talk/","publishdate":"2017-01-01T00:00:00Z","relpermalink":"/talk/example-talk/","section":"event","summary":"An example talk using Wowchemy's Markdown slides feature.","tags":[],"title":"Example Talk","type":"event"},{"authors":["Warsky007"],"categories":["数据库"],"content":"环境介绍 本文基于ClickHouse 20.8.5.45版本编写，操作系统使用的是CentOS 7.5，主要介绍MergeTree表引擎的存储结构以及索引过程。\n创建表 创建语句 CREATE TABLE test_merge_tree ( `Id` UInt64, `Birthday` Date, `Name` String ) ENGINE = MergeTree() PARTITION BY toYYYYMM(Birthday) ORDER BY (Id, Name) SETTINGS index_granularity = 2  语句介绍  ENGINE，表引擎。ClickHouse支持很多种表引擎，本文主要讲解MergeTree，所以选用合并树。 PARTITION BY，分区键。用于指定数据以何种方式分区，合理使用分区可以有效减少查询时文件的扫描范围。 ORDER BY，排序键。用于指定数据以何种方式排序，默认情况下排序键和主键相同。 SETTINGS，配置。创建MergeTree Table时使用的配置，可选的配置有很多，这里只介绍index_granularity。index_granularity表示索引粒度，代表每隔多少行数据生成一条索引，默认值是8192。默认值需要的数据量很大，不方便本文展示数据文件，所以这里我把它调小了。  文件结构 刚刚创建的表只在数据目录下生成了一个名为test_merge_tree文件夹(具体路径为data/default/test_merge_tree)，并没有任何数据，接下来往该表里面插入一条数据，看看会生成哪些文件。\nINSERT INTO test_merge_tree VALUES(1, '2000-02-01', 'Fly li')  在test_merge_tree目录下使用tree命令可以看到刚刚的那条命令生成了一个名为200002_1_1_0的文件夹。\n├── 200002_1_1_0 │ ├── Birthday.bin │ ├── Birthday.mrk2 │ ├── checksums.txt │ ├── columns.txt │ ├── count.txt │ ├── Id.bin │ ├── Id.mrk2 │ ├── minmax_Birthday.idx │ ├── Name.bin │ ├── Name.mrk2 │ ├── partition.dat │ └── primary.idx ├── detached └── format_version.txt  分区目录命名规则 在介绍这些文件之前先介绍一下200002_1_1_0这个目录的命名规则\nPartitionId_MinBlockNum_MaxBlockNum_Level   PartitionId，分区Id。其值是由创建表时所指定的分区键决定的，由于我们创建表时使用的分区键为toYYYYMM(Birthday)，即生日的年月，而插入的Birthday为2000-02-01，所以其值为200002。 MinBlockNum、MaxBlockNum，最小最大数据块编号。其值在单张表内从1开始累加，每当新创建一个分区目录其值就会加1，且新创建的分区目录MinBlockNum和MaxBlockNum相等，只有当分区目录发生合并时其值才会不等。由于这是该表第一次插入数据，所以MinBlockNum和MaxBlockNum都为1。 Level，分区被合并的次数。level和MinBlockNum以及MaxBlockNum不同，它不是单张表内累加的，而是单张表中的单个分区内累加的。每当新创建一个分区目录其值均为0，只有当分区目录发生合并时其值才会大于0。  当分区发生合并时，新的分区目录名称命名规则将会在接下来介绍，这里不做详述。\n文件介绍    文件名 描述 作用     primary.idx 索引文件 用于存放稀疏索引   [Column].mrk2 标记文件 保存了bin文件中数据的偏移信息，用于建立primary.idx和[Column].bin文件之间的映射   [Column].bin 数据文件 存储数据，默认使用lz4压缩存储   partition.dat 分区文件 用于保存分区表达式生成的值   minmax_[Column].idx minmax索引 用于记录当前分区下分区字段的最小最大值   columns.txt 列信息文件 用于保存表的列字段信息   count.txt 计数文件 用于记录当前分区目录下数据的总行数   checksums.txt 校验文件 存放以上各个文件的size以及哈希值，用于快速校验文件的完整性    存储结构 修改min_compress_block_size 在介绍这部分之前，需要先将min_compress_block_size配置改小，以方便分析mrk2和bin文件，其默认值为65535。\n修改方法为在users.xml文件的profiles里面增加以下配置\n\u0026lt;min_compress_block_size\u0026gt;24\u0026lt;/min_compress_block_size\u0026gt;  修改完后重启clickhouse-server服务，然后再用以下命令查看是否修改成功\nSELECT name, value, changed, type FROM system.settings WHERE name = 'min_compress_block_size' ┌─name────────────────────┬─value─┬─changed─┬─type───┐ │ min_compress_block_size │ 24 │ 1 │ UInt64 │ └─────────────────────────┴───────┴─────────┴────────┘  插入数据 刚刚已经插入了一条数据，但是那一条数据不具有代表性，所以这次决定多插入几条数据再来分析。\nINSERT INTO test_merge_tree VALUES(3, '2000-02-03', 'Lisa'),(4, '2000-02-03', 'Lilei'),(6, '2000-02-08', 'Meimei'),(12, '2000-02-03', 'paker'),(31, '2000-02-07', 'vincent')  上面这条命令产生了个新的分区目录200002_2_2_0，此目录下的文件前面已经讲过，现在重点分析以下几个文件的存储格式\nprimary.idx MergeTree表会按照主键字段生成primary.idx，用于加快表查询。前面创建表时使用的是(Id, Name)两个字段作为主键，所以每隔index_granularity行数据就会取(Id, Name)的值作为索引值，由于index_granularity被设置为2，所以每隔两行数据就会生成一个索引。也就是说会使用(3,\u0026lsquo;Lisa\u0026rsquo;), (6,\u0026lsquo;Meimei\u0026rsquo;), (31,\u0026lsquo;vincent\u0026rsquo;)作为索引值。\n这里我只介绍第一个索引(3,\u0026lsquo;Lisa\u0026rsquo;)的存储格式，剩下的可以自己去梳理。Id是UInt64类型的，所以使用8字节来存储。从上图可以看出前8个字节为0x03，以小端模式来存储，接下来我们可以看到其它文件都是以小端模式来存储。Name是String类型，属于变长字段，所以会先使用1个字节来描述String的长度，由于Lisa的长度是4，所以第9个字节为0x04，再接下来就是Lisa的ASCII码。\nId.mrk2 mrk2文件格式比较固定，primary.idx文件中的每个索引在此文件中都有一个对应的Mark，Mark的格式如下图所示：\n Offset in compressed file，8 Bytes，代表该标记指向的压缩数据块在bin文件中的偏移量。 Offset in decompressed block，8 Bytes，代表该标记指向的数据在解压数据块中的偏移量。 Rows count，8 Bytes，行数，通常情况下其等于index_granularity。  通过primary.idx中的索引寻找mrk2文件中对应的Mark非常简单，如果要寻找第n(从0开始)个index，则对应的Mark在mrk2文件中的偏移为n*24，从这个偏移处开始读取24 Bytes即可得到相应的Mark。\nId.bin bin文件由若干个Block组成，由上图可知Id.bin文件中包含两个Block。每个Block主要由头部的Checksum以及若干个Granule组成，Block的格式如下图所示：\n Checksum，16 Bytes，用于对后面的数据进行校验。 Compression algorithm，1 Byte，默认是LZ4，编号为0x82。 Compressed size，4 Bytes，其值等于Compression algorithm + Compressed size + Decompressed size + Compressed data的长度 Decompressed size，4 Bytes，数据解压缩后的长度。 Compressed data，压缩数据，长度为Compressed size - 9。  每个Block都会包含若干个Granule，具体有多少个Granule是由参数min_compress_block_size控制，每次Block中写完一个Granule的数据时，它会检查当前Block Size是否大于等于min_compress_block_size，如果满足则会把当前Block进行压缩然后写到磁盘中，不满足会继续等待下一个Granule。结合上面的INSERT语句，当插入第一个Granule(3, 4)时，数据的的size为16，由于16 \u0026lt; 24所以会等第二个Granule，当插入第二个Granule(6, 12)后数据的size为32，由于32 \u0026gt; 24所以会把(3, 4, 6, 12)压缩放到第一个Block里面。最后面的那个31由于是最后一条数据，就放到第二个Block里面。\npartition.dat partition.dat文件里面存放的是分区表达式的值，该分区表达式生成的值为200002，UInt32类型，转换成16进制就是0x00030d42。\nminmax_Birthday.idx minmax文件里面存放的是该分区里分区字段的最小最大值。分区字段Birthday的类型为Date，其底层由UInt16实现，存的是从1970年1月1号到现在所经过的天数。通过上面的INSERT语句我们可以知道Birthday的最小值为2000-02-03，最大值为2000-02-08。这两个时间转换成天数分别为10990和10995，再转换成16进制就是0x2aee和0x2af3。\n分区合并 属于同一个分区的不同目录，ClickHouse会在分区目录创建后的一段时间自动进行合并，合并之后会生成一个全新的目录，以前老的分区目录不会立马删除，而是在合并后过一段时间再删除。新的分区目录名称遵循以下规则：\n PartitionId，分区Id不变。 MinBlockNum，取该分区中最小的MinBlockNum。 MaxBlockNum，取该分区中最大的MaxBlockNum。 Level，取该分区中最大的Level值加1。  所以上面的两个分区目录200002_1_1_0和200002_2_2_0在过一段时间后最终会变成一个新的分区目录200002_1_2_1。由此可见如果你频繁插入数据会产生很多分区目录，在合并的时候会占用很多资源。所以最好一次插入很多条数据，尽量降低插入的频率。\n索引过程 通过上面的介绍相信大家已经对ClickHouse的索引结构有所了解，接下来用一张图简要描述Id字段的索引过程。\n其它列的索引过程类似，这里就不一一赘述了，有兴趣的朋友可以自己去研究。\n总结 本文通过一个简单的例子来分析ClickHouse的存储结构，整个逻辑力求简洁明了，希望通过本文能够让喜欢ClickHouse的朋友对它的索引有个清晰的认识。\n","date":1610409600,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1610409600,"objectID":"1b2c4cff8468d714c45baf5e95814c7a","permalink":"https://warsky007.github.io/post/clickhouse-storage-index/","publishdate":"2021-01-12T00:00:00Z","relpermalink":"/post/clickhouse-storage-index/","section":"post","summary":"ClickHouse存储结构及索引详解","tags":["ClickHouse"],"title":"ClickHouse存储结构及索引详解","type":"post"},{"authors":["Warsky007"],"categories":["随笔"],"content":"2020年已经过去，去年注定是个不平凡的一年，新冠病毒肆虐，很多人因为疫情而举步维艰，也有一些人甚至失去了生命。幸运的是我这个小家庭没有受到太大的影响，家人孩子一切平安。\n平时工作很忙，周末还要回家带娃，我每天就这么忙碌着，浑浑噩噩的过着。突然有一天我感觉时间过的好快，似乎自己什么也没做一年就这样过去了，而人生又有多少个一年呢？我想我该放慢脚步，用心记录下生活中的美好瞬间，这样等哪一天闲的没事了，看着这些东西也许就不会觉得我在浪费青春了。\n好记性不如烂笔头，希望在接下来的工作当中能够多抽出一些时间来记录工作中遇到的一些问题，解决方案，以及学到的一些知识。\n好的东西就是要拿出来分享，愿与君共勉！！！\n","date":1610064000,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1610064000,"objectID":"279b9966ca9cf3121ce924dca452bb1c","permalink":"https://warsky007.github.io/post/getting-started/","publishdate":"2021-01-08T00:00:00Z","relpermalink":"/post/getting-started/","section":"post","summary":"门户的第一篇博客","tags":["生活"],"title":"嗖...","type":"post"},{"authors":[],"categories":[],"content":"Create slides in Markdown with Wowchemy Wowchemy | Documentation\n Features  Efficiently write slides in Markdown 3-in-1: Create, Present, and Publish your slides Supports speaker notes Mobile friendly slides   Controls  Next: Right Arrow or Space Previous: Left Arrow Start: Home Finish: End Overview: Esc Speaker notes: S Fullscreen: F Zoom: Alt + Click PDF Export: E   Code Highlighting Inline code: variable\nCode block:\nporridge = \u0026quot;blueberry\u0026quot; if porridge == \u0026quot;blueberry\u0026quot;: print(\u0026quot;Eating...\u0026quot;)   Math In-line math: $x + y = z$\nBlock math:\n$$ f\\left( x \\right) = ;\\frac{{2\\left( {x + 4} \\right)\\left( {x - 4} \\right)}}{{\\left( {x + 4} \\right)\\left( {x + 1} \\right)}} $$\n Fragments Make content appear incrementally\n{{% fragment %}} One {{% /fragment %}} {{% fragment %}} **Two** {{% /fragment %}} {{% fragment %}} Three {{% /fragment %}}  Press Space to play!\nOne  Two  Three \n A fragment can accept two optional parameters:\n class: use a custom style (requires definition in custom CSS) weight: sets the order in which a fragment appears   Speaker Notes Add speaker notes to your presentation\n{{% speaker_note %}} - Only the speaker can read these notes - Press `S` key to view {{% /speaker_note %}}  Press the S key to view the speaker notes!\n Only the speaker can read these notes Press S key to view    Themes  black: Black background, white text, blue links (default) white: White background, black text, blue links league: Gray background, white text, blue links beige: Beige background, dark text, brown links sky: Blue background, thin dark text, blue links    night: Black background, thick white text, orange links serif: Cappuccino background, gray text, brown links simple: White background, black text, blue links solarized: Cream-colored background, dark green text, blue links   Custom Slide Customize the slide style and background\n{{\u0026lt; slide background-image=\u0026quot;/media/boards.jpg\u0026quot; \u0026gt;}} {{\u0026lt; slide background-color=\u0026quot;#0000FF\u0026quot; \u0026gt;}} {{\u0026lt; slide class=\u0026quot;my-style\u0026quot; \u0026gt;}}   Custom CSS Example Let\u0026rsquo;s make headers navy colored.\nCreate assets/css/reveal_custom.css with:\n.reveal section h1, .reveal section h2, .reveal section h3 { color: navy; }   Questions? Ask\nDocumentation\n","date":1549324800,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1549324800,"objectID":"0e6de1a61aa83269ff13324f3167c1a9","permalink":"https://warsky007.github.io/slides/example/","publishdate":"2019-02-05T00:00:00Z","relpermalink":"/slides/example/","section":"slides","summary":"An introduction to using Wowchemy's Slides feature.","tags":[],"title":"Slides","type":"slides"},{"authors":null,"categories":null,"content":"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis posuere tellus ac convallis placerat. Proin tincidunt magna sed ex sollicitudin condimentum. Sed ac faucibus dolor, scelerisque sollicitudin nisi. Cras purus urna, suscipit quis sapien eu, pulvinar tempor diam. Quisque risus orci, mollis id ante sit amet, gravida egestas nisl. Sed ac tempus magna. Proin in dui enim. Donec condimentum, sem id dapibus fringilla, tellus enim condimentum arcu, nec volutpat est felis vel metus. Vestibulum sit amet erat at nulla eleifend gravida.\nNullam vel molestie justo. Curabitur vitae efficitur leo. In hac habitasse platea dictumst. Sed pulvinar mauris dui, eget varius purus congue ac. Nulla euismod, lorem vel elementum dapibus, nunc justo porta mi, sed tempus est est vel tellus. Nam et enim eleifend, laoreet sem sit amet, elementum sem. Morbi ut leo congue, maximus velit ut, finibus arcu. In et libero cursus, rutrum risus non, molestie leo. Nullam congue quam et volutpat malesuada. Sed risus tortor, pulvinar et dictum nec, sodales non mi. Phasellus lacinia commodo laoreet. Nam mollis, erat in feugiat consectetur, purus eros egestas tellus, in auctor urna odio at nibh. Mauris imperdiet nisi ac magna convallis, at rhoncus ligula cursus.\nCras aliquam rhoncus ipsum, in hendrerit nunc mattis vitae. Duis vitae efficitur metus, ac tempus leo. Cras nec fringilla lacus. Quisque sit amet risus at ipsum pharetra commodo. Sed aliquam mauris at consequat eleifend. Praesent porta, augue sed viverra bibendum, neque ante euismod ante, in vehicula justo lorem ac eros. Suspendisse augue libero, venenatis eget tincidunt ut, malesuada at lorem. Donec vitae bibendum arcu. Aenean maximus nulla non pretium iaculis. Quisque imperdiet, nulla in pulvinar aliquet, velit quam ultrices quam, sit amet fringilla leo sem vel nunc. Mauris in lacinia lacus.\nSuspendisse a tincidunt lacus. Curabitur at urna sagittis, dictum ante sit amet, euismod magna. Sed rutrum massa id tortor commodo, vitae elementum turpis tempus. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean purus turpis, venenatis a ullamcorper nec, tincidunt et massa. Integer posuere quam rutrum arcu vehicula imperdiet. Mauris ullamcorper quam vitae purus congue, quis euismod magna eleifend. Vestibulum semper vel augue eget tincidunt. Fusce eget justo sodales, dapibus odio eu, ultrices lorem. Duis condimentum lorem id eros commodo, in facilisis mauris scelerisque. Morbi sed auctor leo. Nullam volutpat a lacus quis pharetra. Nulla congue rutrum magna a ornare.\nAliquam in turpis accumsan, malesuada nibh ut, hendrerit justo. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Quisque sed erat nec justo posuere suscipit. Donec ut efficitur arcu, in malesuada neque. Nunc dignissim nisl massa, id vulputate nunc pretium nec. Quisque eget urna in risus suscipit ultricies. Pellentesque odio odio, tincidunt in eleifend sed, posuere a diam. Nam gravida nisl convallis semper elementum. Morbi vitae felis faucibus, vulputate orci placerat, aliquet nisi. Aliquam erat volutpat. Maecenas sagittis pulvinar purus, sed porta quam laoreet at.\n","date":1461715200,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1461715200,"objectID":"e8f8d235e8e7f2efd912bfe865363fc3","permalink":"https://warsky007.github.io/project/example/","publishdate":"2016-04-27T00:00:00Z","relpermalink":"/project/example/","section":"project","summary":"An example of using the in-built project page.","tags":["Deep Learning"],"title":"Example Project","type":"project"},{"authors":["Warsky007","Robert Ford"],"categories":null,"content":" Click the Cite button above to demo the feature to enable visitors to import publication metadata into their reference management software.    Create your slides in Markdown - click the Slides button to check out the example.   Supplementary notes can be added here, including code, math, and images.\n","date":1372636800,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1372636800,"objectID":"ff6a19061a984819d30c916886db56ef","permalink":"https://warsky007.github.io/publication/example/","publishdate":"2017-01-01T00:00:00Z","relpermalink":"/publication/example/","section":"publication","summary":"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis posuere tellus ac convallis placerat. Proin tincidunt magna sed ex sollicitudin condimentum.","tags":[],"title":"An example conference paper","type":"publication"}]